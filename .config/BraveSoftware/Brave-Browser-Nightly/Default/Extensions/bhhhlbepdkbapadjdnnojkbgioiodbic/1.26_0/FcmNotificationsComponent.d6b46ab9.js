"use strict";(self.webpackChunksolflare=self.webpackChunksolflare||[]).push([["FcmNotificationsComponent"],{"./src/common/components/FcmNotifications/index.js":function(t,e,n){n.r(e),n.d(e,{default:function(){return H}});var o,r,i,a,s,c,u=n("./node_modules/@material-ui/core/esm/IconButton/IconButton.js"),l=n("./node_modules/@material-ui/icons/esm/Close.js"),p=n("./node_modules/@material-ui/core/esm/Container/Container.js"),f=n("./node_modules/@material-ui/core/esm/Button/Button.js"),m=n("./node_modules/@material-ui/core/esm/Box/Box.js"),d=n("./node_modules/react/index.js"),h=n("./node_modules/prop-types/index.js"),y=n.n(h),b=n("./node_modules/firebase/app/dist/index.esm.js"),g=n("./node_modules/firebase/messaging/dist/index.esm.js"),v=n("./src/actions/notifications.js"),w=n("./src/actions/notificationProtocol.js"),k=n("./src/common/utils/extension.js"),j=n("./src/common/utils/notifications.js"),O=n("./node_modules/react-redux/es/index.js"),I=n("./node_modules/react-i18next/dist/es/withTranslation.js"),N=n("./node_modules/@material-ui/core/esm/styles/withStyles.js"),_=n("./node_modules/lodash/lodash.js"),P=n("./node_modules/reselect/es/index.js"),S=n("./src/selectors/config.js"),x=n("./src/selectors/data.js"),T=(0,P.P1)(S.ut,(function(t){var e=t.wallets,n=t.accounts;return t.loggedIn?{accounts:n.map((function(t){var n=t.name,o=t.publicKey;return{name:n,publicKey:o,type:e[o].type}}))}:{accounts:[]}})),E=(0,P.zB)({walletAccounts:T,network:S.eN,notificationProtocol:x.Cj}),R=n("./node_modules/react-router/esm/react-router.js");function C(t){return C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},C(t)}function A(t,e,n,o,r,i,a){try{var s=t[i](a),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(o,r)}function D(t){return function(){var e=this,n=arguments;return new Promise((function(o,r){var i=t.apply(e,n);function a(t){A(i,o,r,a,s,"next",t)}function s(t){A(i,o,r,a,s,"throw",t)}a(void 0)}))}}function B(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function F(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?B(Object(n),!0).forEach((function(e){W(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):B(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function M(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function z(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function Z(t,e){return Z=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},Z(t,e)}function L(t,e){if(e&&("object"===C(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return U(t)}function U(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function K(t){return K=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},K(t)}function W(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var q=(o=(0,n("./src/common/components/withWallet/index.js").a)(),r=(0,I.Z)(),i=(0,N.Z)((function(t){var e;return{strip:{position:"relative",backgroundColor:t.palette.primary.light},valign:{position:"absolute",top:"50%",right:10,transform:"translateY(-50%)"},content:(e={display:"flex",alignItems:"center",justifyContent:"space-between"},W(e,t.breakpoints.down("sm"),{flexDirection:"column"}),W(e,"paddingTop",10),W(e,"paddingBottom",10),W(e,"color",t.palette.text.primary),e),buttonLabel:{fontSize:"14px !important"},text:{opacity:.5}}})),a=(0,O.$j)(E,{initializeNotifications:v._R,initializeNotificationsFromRemote:v.Bn,getRemoteDeviceState:v.HU,removeRemoteDeviceState:v.zH,notificationPlatformConnections:w.WB}),(0,R.EN)(s=o(s=r(s=i(s=a((c=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Z(t,e)}(w,t);var e,n,o,r,i,a,s,c,h,y,v=(h=w,y=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=K(h);if(y){var n=K(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return L(this,t)});function w(){var t;M(this,w);for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return W(U(t=v.call.apply(v,[this].concat(n))),"state",{show:!1,listener:!1,worker:null,workerPort:null}),W(U(t),"firebaseConfig",{apiKey:"AIzaSyBnuytdyhVuSzo0qAhX5QWYu6Z2jTBPWog",authDomain:"solflare-d0638.firebaseapp.com",projectId:"solflare-d0638",storageBucket:"solflare-d0638.appspot.com",messagingSenderId:"191112318129",appId:"1:191112318129:web:a3555b4ee54f13a6efa690"}),W(U(t),"debouncedGetFirebaseToken",(function(){var e=t.state,n=e.worker,o=e.workerPort;n&&n.port.postMessage({id:"notification-permission-".concat(Math.floor(Date.now()/2e3)),type:"NOTIFICATION_PERMISSION",portId:o})})),W(U(t),"registerSharedWorker",(function(){var e=t.props,n=e.i18n,o=e.initializeNotificationsFromRemote,r=new SharedWorker("notification-worker.js");r.port.addEventListener("message",(function(e){"CONNECTION"===e.data.type?(t.setState(F(F({},t.state),{},{workerPort:e.data.portId})),t.debouncedGetFirebaseToken()):"NOTIFICATION_PERMISSION"===e.data.type?t.getFirebaseToken():"NOTIFICATION_RELOAD_STATE"===e.data.type?o(n.language).then():"NOTIFICATION"===e.data.type&&(new Notification(e.data.notificationTitle,e.data.notificationOptions).onclick=function(t){t.preventDefault(),t.target.close();var e=t.target.data,n=k.p?"/wallet.html#":"",o="".concat(n,"/portfolio");e&&e.publicKey&&(o="".concat(n,"/deeplink/").concat(e.publicKey,"/activity")),e&&e.actionUrl&&(o=e.actionUrl),window.open(o,"_self")})})),r.port.start(),t.setState(F(F({},t.state),{},{worker:r}))})),W(U(t),"askForNotifications",(function(){(0,j.AX)(t.props.location,t.props.history),t.onClose()})),W(U(t),"onClose",(function(){var e=t.props.notificationProtocol.connections.length?Date.now()+j.vM:0;localStorage.setItem("solflareEnableNotificationsModal","".concat(e)),t.setState(F(F({},t.state),{},{show:!1}))})),t}return e=w,n=[{key:"componentDidMount",value:(c=D(regeneratorRuntime.mark((function t(){var e,n,o,r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=this.props,n=e.wallet,o=e.network,r=e.notificationPlatformConnections,(0,j.Yz)()&&"mainnet"===o.cluster){t.next=3;break}return t.abrupt("return");case 3:if(!k.p||!window.location.pathname.includes("confirm_popup.html")){t.next=6;break}return this.setupNotifications().then(),t.abrupt("return");case 6:if(!("permissions"in navigator)){t.next=11;break}return t.next=9,navigator.permissions.query({name:"notifications"});case 9:this.permissionStatus=t.sent,this.permissionStatus.addEventListener("change",this.debouncedGetFirebaseToken);case 11:this.setupNotifications().then(),this.checkPromptAvailability().then(),(0,j.YE)(n.instance.type)&&r({publicKey:n.instance.publicKey,timestamp:Date.now(),wallet:n});case 14:case"end":return t.stop()}}),t,this)}))),function(){return c.apply(this,arguments)})},{key:"componentDidUpdate",value:function(t,e,n){(0,_.isEqual)(t.notificationProtocol,this.props.notificationProtocol)||this.checkPromptAvailability().then()}},{key:"componentWillUnmount",value:(s=D(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.permissionStatus&&this.permissionStatus.removeEventListener("change",this.debouncedGetFirebaseToken);case 1:case"end":return t.stop()}}),t,this)}))),function(){return s.apply(this,arguments)})},{key:"setupNotifications",value:(a=D(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:(0,b.ZF)(this.firebaseConfig),this.registerSharedWorker(),this.props.initializeNotifications().then();case 3:case"end":return t.stop()}}),t,this)}))),function(){return a.apply(this,arguments)})},{key:"checkPromptAvailability",value:(i=D(regeneratorRuntime.mark((function t(){var e,n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=this.props.notificationProtocol,null!==(n=localStorage.getItem("solflareEnableNotificationsModal"))){t.next=5;break}return this.setState(F(F({},this.state),{},{show:!0})),t.abrupt("return");case 5:(0===(n="true"===n?0:parseInt(n,10))||Date.now()>n)&&e.connections.length&&this.setState(F(F({},this.state),{},{show:!0}));case 7:case"end":return t.stop()}}),t,this)}))),function(){return i.apply(this,arguments)})},{key:"handleMessage",value:(r=D(regeneratorRuntime.mark((function t(e){var n,o,r,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.state.worker){t.next=2;break}return t.abrupt("return");case 2:n=null,o=null,r="/assets/logo-128.png",e.data.icon&&(r=e.data.icon),e.data&&(["notification","broadcast","cast","event"].includes(e.data.type)&&(n=e.data.title,o={body:e.data.body,icon:r,data:e.data}),this.state.worker.port.postMessage({type:"NOTIFICATION",notificationId:null!==(i=e.data.uuid)&&void 0!==i?i:e.messageId,notificationTitle:n,notificationOptions:o,portId:this.state.workerPort}));case 7:case"end":return t.stop()}}),t,this)}))),function(t){return r.apply(this,arguments)})},{key:"getFirebaseToken",value:(o=D(regeneratorRuntime.mark((function t(){var e,n,o,r,i,a,s=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=this.props,n=e.i18n,o=e.t,r=e.walletAccounts,"granted"!==Notification.permission){t.next=14;break}return i=(0,g.KL)(),t.next=5,(0,g.LP)(i,{vapidKey:"BJaqqoHkXBHpbb5TjC0jks2gmd6rEfFrDu9BBk89E7IaU6bvzD6BscmDf9ryfyfsmyH-c_e0aqEwX-86UD0VHII"});case 5:if(!(a=t.sent)){t.next=14;break}return this.state.listener||((0,g.ps)(i,(function(t){s.handleMessage(t)})),this.setState({listener:!0})),t.next=10,this.props.getRemoteDeviceState({language:n.language,pushToken:a,osVersion:"1",accounts:r.accounts});case 10:return t.sent||this.state.worker.port.postMessage({type:"NOTIFICATION",notificationId:"enabled-notifications-".concat(Math.floor(Date.now()/2e3)),notificationTitle:o("notifications_enabled_title"),notificationOptions:{body:o("notifications_enabled_body"),icon:"/assets/logo-128.png"},portId:this.state.workerPort}),this.state.worker.port.postMessage({type:"NOTIFICATION_RELOAD_STATE",portId:this.state.workerPort}),t.abrupt("return");case 14:return t.next=16,this.props.removeRemoteDeviceState({language:n.language});case 16:this.state.worker.port.postMessage({type:"NOTIFICATION_RELOAD_STATE",portId:this.state.workerPort});case 17:case"end":return t.stop()}}),t,this)}))),function(){return o.apply(this,arguments)})},{key:"render",value:function(){var t=this.props,e=t.t,n=t.classes;return!k.C&&k.p?null:this.state.show&&"granted"!==Notification.permission?!k.p&&location.pathname.includes("/provider")?null:d.createElement(m.Z,{className:n.strip},d.createElement(p.Z,{className:n.content},d.createElement(m.Z,null,d.createElement(m.Z,{display:"inline"},e("notifications_prompt_title")),d.createElement(m.Z,{display:"inline",ml:2,className:n.text},e("notifications_prompt_text"))),d.createElement(f.Z,{type:"button",size:"small",color:"primary",classes:{label:n.buttonLabel},onClick:this.askForNotifications},e("notifications_prompt_enable"))),d.createElement(m.Z,{className:n.valign},d.createElement(u.Z,{onClick:this.onClose},d.createElement(l.Z,{color:"primary"})))):null}}],n&&z(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),w}(d.Component),W(c,"propTypes",{t:y().func,i18n:y().object,wallet:y().object,history:y().object,classes:y().object,network:y().object,location:y().object,walletAccounts:y().object,getRemoteDeviceState:y().func,notificationProtocol:y().object,removeRemoteDeviceState:y().func,initializeNotifications:y().func,initializeNotificationsFromRemote:y().func,notificationPlatformConnections:y().func}),s=c))||s)||s)||s)||s)||s),H=q},"./src/common/utils/notifications.js":function(t,e,n){n.d(e,{AE:function(){return f},AX:function(){return u},Gc:function(){return p},L5:function(){return l},YE:function(){return c},Yz:function(){return s},fZ:function(){return m},vM:function(){return a}});var o=n("./src/common/utils/localStorage.js"),r=n("./src/common/utils/extension.js"),i=n("./src/wallet/shared.js"),a=6048e5,s=function(){var t=/Chrome/.test(navigator.userAgent);return r.p?t:/Firefox/.test(navigator.userAgent)||t},c=function(t){return[i.R7,i.vn].includes(t)},u=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"1",o=new URLSearchParams(t.search);o.set("msNotifications",n);var r=Array.from(o).length?"?".concat(o.toString()):"";e.push(t.pathname+r+t.hash)},l=function(t){window.open("/wallet.html#/portfolio?msNotifications=".concat(t),"_blank")},p=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=(0,o.er)("solflarenotificationapps")||{};if(void 0===r[t])r[t]={until:n?-1:e,untilBanner:n?e:-1};else{var i=r[t];r[t]={until:n?i.until:e,untilBanner:n?e:i.untilBanner}}(0,o.BU)(r,"solflarenotificationapps")},f=function(t,e){var n=(0,o.er)("solflarenotificationapps")||{};return void 0===n[t]?-1:e?n[t].untilBanner:n[t].until},m=function(t){var e=(0,o.er)("solflarenotificationapps")||{};delete e[t],(0,o.BU)(e,"solflarenotificationapps")}}}]);